<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>wireleap</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.9.1/dist/cdn.min.js"></script>
  <style>
    [x-cloak] {
      display: none !important;
    }
    .scroll-container::-webkit-scrollbar {
      width: 5px;
      height: 5px;
    }
    .scroll-container::-webkit-scrollbar-thumb {
      background-color: lightgrey;
      border-radius: 5px;
    }
    .scroll-container::-webkit-scrollbar-track {
      margin-top: 5px;
      margin-bottom: 5px;
    }
  </style>
</head>

<body>

<div x-data="alpineInstance()" x-init="initialize()">

<div x-show="breakpoints">
  <div class="flex items-center justify-center fixed top-0 right-0 mt-8 mr-8 z-50 w-8 h-8 rounded-full text-gray-700 text-sm uppercase bg-gray-200 sm:bg-yellow-200 md:bg-green-200 lg:bg-purple-200 xl:bg-red-200">
    <span class="block sm:hidden">all</span>
    <span class="hidden sm:block md:hidden">sm</span>
    <span class="hidden md:block lg:hidden">md</span>
    <span class="hidden lg:block xl:hidden">lg</span>
    <span class="hidden xl:block">xl</span>
  </div>
</div>

<div class="relative min-h-screen flex flex-col">
  <div class="flex-grow w-full mx-auto md:flex">

    <div class="flex-1 min-w-0 bg-white xl:flex">
      <!-- left column -->
      <div class="hidden xl:block w-1/3 border-b border-gray-200 border-b-0 flex-shrink-0 border-r border-gray-200 bg-white">
        <div class="h-full p-6">
          <div class="h-full relative space-y-3 scroll-container overflow-y-auto overflow-hidden pb-10" style="min-height: 12rem">

            <div class="flex items-center justify-between">
              <a class="text-xs text-blue-600" href="http://alonswartz-temp.s3-website-us-east-1.amazonaws.com/wireleap.com/docs/client-api/" target="_blank">API Spec</a>
              <button @click="refresh()" class="border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">refresh</button>
            </div>

            <p class="text-xs text-gray-900 font-medium uppercase pb-2 pt-4">Core</p>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">version</summary>
              <template x-if="error.version"><p class="p-1 bg-red-200" x-text="error.version"></template>
              <template x-if="cache.version">
                <ul class="ml-1 p-2 border-l-2 border-blue-200">
                  <li>version: <span x-text="cache.version.version"></span></li>
                </ul>
              </template>
            </details>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">status</summary>
              <template x-if="error.status"><p class="p-1 bg-red-200" x-text="error.status"></template>
              <template x-if="cache.status">
                <ul class="ml-1 p-2 border-l-2 border-blue-200">
                  <li>home: <span x-text="cache.status.home"></span></li>
                  <li>pid: <span x-text="cache.status.pid"></span></li>
                  <li>state: <span x-text="cache.status.state"></span></li>
                  <li>broker.active_circuit: <span x-text="cache.status.broker.active_circuit"></span></li>
                  <li>upgrade.required: <span x-text="cache.status.upgrade.required"></span></li>
                </ul>
              </template>
            </details>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">config</summary>
              <template x-if="error.config"><p class="p-1 bg-red-200" x-text="error.config"></template>
              <template x-if="cache.config">
                <ul class="ml-1 p-2 border-l-2 border-blue-200">
                  <li>address: <span x-text="cache.config.address"></span></li>
                  <li>broker.address: <span x-text="cache.config.broker.address"></span></li>
                  <li>broker.accesskey.use_on_demand: <span x-text="cache.config.broker.accesskey.use_on_demand"></span></li>
                  <li>broker.circuit.timeout: <span x-text="cache.config.broker.circuit.timeout"></span></li>
                  <li>broker.circuit.hops: <span x-text="cache.config.broker.circuit.hops"></span></li>
                  <li>broker.circuit.whitelist: <span x-text="cache.config.broker.circuit.whitelist"></span></li>
                  <li>forwarders.socks.address: <span x-text="cache.config.forwarders.socks.address"></span></li>
                  <li>forwarders.tun.address: <span x-text="cache.config.forwarders.tun.address"></span></li>
                </ul>
              </template>
            </details>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">runtime</summary>
              <template x-if="error.runtime"><p class="p-1 bg-red-200" x-text="error.runtime"></template>
              <template x-if="cache.runtime">
                <ul class="ml-1 p-2 border-l-2 border-blue-200">
                  <li>versions.software: <span x-text="cache.runtime.versions.software"></span></li>
                  <li>versions.api: <span x-text="cache.runtime.versions.api"></span></li>
                  <li>versions.client-contract: <span x-text="cache.runtime.versions['client-contract']"></span></li>
                  <li>versions.client-dir: <span x-text="cache.runtime.versions['client-dir']"></span></li>
                  <li>versions.client-relay: <span x-text="cache.runtime.versions['client-relay']"></span></li>
                  <li>upgrade.supported: <span x-text="cache.runtime.upgrade.supported"></span></li>
                  <li>build.gitcommit: <span x-text="cache.runtime.build.gitcommit"></span></li>
                  <li>build.goversion: <span x-text="cache.runtime.build.goversion"></span></li>
                  <li>build.time: <span x-text="cache.runtime.build.time"></span></li>
                  <li>build.flags: <span x-text="cache.runtime.build.flags"></span></li>
                  <li>platform.os: <span x-text="cache.runtime.platform.os"></span></li>
                  <li>platform.arch: <span x-text="cache.runtime.platform.arch"></span></li>
                </ul>
              </template>
            </details>

            <p class="text-xs text-gray-900 font-medium uppercase pb-2 pt-4">Resources</p>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">accesskeys</summary>
              <template x-if="error.accesskeys"><p class="p-1 bg-red-200" x-text="error.accesskeys"></template>
              <template x-if="cache.accesskeys">
                <template x-for="accesskey in cache.accesskeys">
                  <ul class="ml-1 p-2 border-l-2 border-blue-200">
                    <li>contract: <span x-text="accesskey.contract"></span></li>
                    <li>duration: <span x-text="accesskey.duration"></span></li>
                    <li>expiration: <span x-text="accesskey.expiration"></span></li>
                    <li>state: <span x-text="accesskey.state"></span></li>
                  </ul>
                </template>
              </template>
            </details>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">relays</summary>
              <template x-if="error.relays"><p class="p-1 bg-red-200" x-text="error.relays"></template>
              <template x-if="cache.relays">
                <template x-for="relay in cache.relays">
                  <ul class="ml-1 p-2 border-l-2 border-blue-200">
                    <li>role: <span x-text="relay.role"></span></li>
                    <li>address: <span x-text="relay.address"></span></li>
                    <li>pubkey: <span x-text="relay.pubkey"></span></li>
                    <li>selectable: <span x-text="relay.selectable"></span></li>
                    <li>versions.software: <span x-text="relay.versions.software"></span></li>
                    <li>versions.client-relay: <span x-text="relay.versions['client-relay']"></span></li>
                  </ul>
                </template>
              </template>
            </details>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">contract</summary>
              <template x-if="error.contract"><p class="p-1 bg-red-200" x-text="error.contract"></template>
              <template x-if="cache.contract">
                <ul class="ml-1 p-2 border-l-2 border-blue-200">
                  <li>pubkey: <span x-text="cache.contract.pubkey"></span></li>
                  <li>version: <span x-text="cache.contract.version"></span></li>
                  <li>endpoint: <span x-text="cache.contract.endpoint"></span></li>
                  <template x-for="proof_of_funding in cache.contract.proof_of_funding">
                    <ul class="py-2">
                      <li>proof_of_funding.type: <span x-text="proof_of_funding.type"></span></li>
                      <li>proof_of_funding.endpoint: <span x-text="proof_of_funding.endpoint"></span></li>
                      <li>proof_of_funding.pubkey: <span x-text="proof_of_funding.pubkey"></span></li>
                    </ul>
                  </template>
                  <li>servicekey.duration: <span x-text="cache.contract.servicekey.duration"></span></li>
                  <li>servicekey.currency: <span x-text="cache.contract.servicekey.currency"></span></li>
                  <li>servicekey.value: <span x-text="cache.contract.servicekey.value"></span></li>
                  <li>directory.endpoint: <span x-text="cache.contract.directory.endpoint"></span></li>
                  <li>directory.public_key: <span x-text="cache.contract.directory.public_key"></span></li>
                  <li>metadata.operator: <span x-text="cache.contract.metadata.operator"></span></li>
                  <li>metadata.operator_url: <span x-text="cache.contract.metadata.operator_url"></span></li>
                  <li>metadata.name: <span x-text="cache.contract.metadata.name"></span></li>
                  <li>metadata.terms_of_service: <span x-text="cache.contract.metadata.terms_of_service"></span></li>
                  <li>metadata.privacy_policy: <span x-text="cache.contract.metadata.privacy_policy"></span></li>
                </ul>
              </template>
            </details>

            <p class="text-xs text-gray-900 font-medium uppercase pb-2 pt-4">Forwarders</p>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">socks</summary>
              <template x-if="error.forwarders_socks"><p class="p-1 bg-red-200" x-text="error.forwarders_socks"></template>
              <template x-if="cache.forwarders_socks">
                <ul class="ml-1 p-2 border-l-2 border-blue-200">
                  <li>pid: <span x-text="cache.forwarders_socks.pid"></span></li>
                  <li>state: <span x-text="cache.forwarders_socks.state"></span></li>
                  <li>address: <span x-text="cache.forwarders_socks.address"></span></li>
                  <li>binary.ok: <span x-text="cache.forwarders_socks.binary.ok"></span></li>
                  <li>binary.state.exists: <span x-text="cache.forwarders_socks.binary.state.exists"></span></li>
                  <li>binary.state.chmod_x: <span x-text="cache.forwarders_socks.binary.state.chmod_x"></span></li>
                </ul>
              </template>
            </details>

            <details class="text-xs whitespace-nowrap cursor-pointer">
              <summary class="text-gray-600 font-light">tun</summary>
              <template x-if="error.forwarders_tun"><p class="p-1 bg-red-200" x-text="error.forwarders_tun"></template>
              <template x-if="cache.forwarders_tun">
                <ul class="ml-1 p-2 border-l-2 border-blue-200">
                  <li>pid: <span x-text="cache.forwarders_tun.pid"></span></li>
                  <li>state: <span x-text="cache.forwarders_tun.state"></span></li>
                  <li>address: <span x-text="cache.forwarders_tun.address"></span></li>
                  <li>binary.ok: <span x-text="cache.forwarders_tun.binary.ok"></span></li>
                  <li>binary.state.exists: <span x-text="cache.forwarders_tun.binary.state.exists"></span></li>
                  <li>binary.state.chown_0: <span x-text="cache.forwarders_tun.binary.state.chown_0"></span></li>
                  <li>binary.state.chmod_x: <span x-text="cache.forwarders_tun.binary.state.chmod_x"></span></li>
                  <li>binary.state.chmod_us: <span x-text="cache.forwarders_tun.binary.state.chmod_us"></span></li>
                </ul>
              </template>
            </details>

          </div>
        </div>
      </div>

      <!-- main area -->
      <div class="bg-white min-w-0">
        <div class="h-full p-6">
          <!-- Start main area-->
          <div class="relative h-screen" style="min-height: 36rem">

            <div x-cloak x-transition x-show="alertSuccess" class="mb-5 rounded-md bg-green-50 p-3">
              <div class="flex items-center">
                <div class="ml-3">
                  <p class="text-xs text-green-800" x-text="alertSuccess"></p>
                </div>
                <div class="ml-auto pl-3">
                  <div class="-mx-1.5 -my-1.5">
                    <button @click="alertSuccess=''" type="button" class="inline-flex bg-green-50 rounded-md p-1.5 text-green-500 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-green-50 focus:ring-green-600">
                      <span class="sr-only">Dismiss</span>
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div x-cloak x-transition x-show="alertError" class="mb-5 rounded-md bg-red-50 p-3">
              <div class="flex items-center">
                <div class="ml-3">
                  <p class="text-xs text-red-800" x-text="alertError"></p>
                </div>
                <div class="ml-auto pl-3">
                  <div class="-mx-1.5 -my-1.5">
                    <button @click="alertError=''" type="button" class="inline-flex bg-red-50 rounded-md p-1.5 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-red-50 focus:ring-red-600">
                      <span class="sr-only">Dismiss</span>
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div x-cloak x-transition x-show="alertInfo" class="mb-5 rounded-md bg-gray-50 p-3">
              <div class="flex items-center">
                <div class="ml-3">
                  <p class="text-xs text-gray-800" x-text="alertInfo"></p>
                </div>
                <div class="ml-auto pl-3">
                  <div class="-mx-1.5 -my-1.5">
                    <div class="text-gray-800 rounded-full p-1.5 transition duration-300">
                      <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-4 w-4" viewBox="0 0 1024 1024" fill="currentColor">
                        <path d="M909.1 209.3l-56.4 44.1C775.8 155.1 656.2 92 521.9 92 290 92 102.3 279.5 102 511.5 101.7 743.7 289.8 932 521.9 932c181.3 0 335.8-115 394.6-276.1 1.5-4.2-.7-8.9-4.9-10.3l-56.7-19.5a8 8 0 00-10.1 4.8c-1.8 5-3.8 10-5.9 14.9-17.3 41-42.1 77.8-73.7 109.4A344.77 344.77 0 01655.9 829c-42.3 17.9-87.4 27-133.8 27-46.5 0-91.5-9.1-133.8-27A341.5 341.5 0 01279 755.2a342.16 342.16 0 01-73.7-109.4c-17.9-42.4-27-87.4-27-133.9s9.1-91.5 27-133.9c17.3-41 42.1-77.8 73.7-109.4 31.6-31.6 68.4-56.4 109.3-73.8 42.3-17.9 87.4-27 133.8-27 46.5 0 91.5 9.1 133.8 27a341.5 341.5 0 01109.3 73.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.6 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c-.1-6.6-7.8-10.3-13-6.2z" />
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-5">

              <div class="border border-gray-200 rounded p-2">
                <div class="flex items-center justify-between">
                  <p class="text-xs text-gray-900 font-medium">SOCKS Forwarder</p>
                  <template x-if="cache.forwarders_socks">
                    <p class="text-xs" :class="cache.forwarders_socks.state == 'active' ? 'text-green-600' : 'text-gray-900'"  x-text="cache.forwarders_socks.state"></p>
                  </template>
                </div>
                <template x-if="cache.forwarders_socks">
                  <div class="py-4">
                    <div x-show="cache.forwarders_socks.binary.ok">
                      <button @click="apiPostJson('/api/forwarders/socks/start')" :disabled="cache.forwarders_socks.state == 'active'" class="disabled:text-gray-200 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">start</button>
                      <button @click="apiPostJson('/api/forwarders/socks/stop')" :disabled="cache.forwarders_socks.state != 'active'" class="disabled:text-gray-200 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">stop</button>
                    </div>
                    <div x-show="!cache.forwarders_socks.binary.ok" class="bg-red-200 p-2 mt-5 rounded text-xs">
                      <ul>
                        <li>binary.state.exists: <span x-text="cache.forwarders_socks.binary.state.exists"></span></li>
                        <li>binary.state.chmod_x: <span x-text="cache.forwarders_socks.binary.state.chmod_x"></span></li>
                      </ul>
                    </div>
                  </div>
                </template>
              </div>

              <div class="border border-gray-200 rounded p-2">
                <div class="flex items-center justify-between">
                  <p class="text-xs text-gray-900 font-medium">TUN Forwarder</p>
                  <template x-if="cache.forwarders_tun">
                    <p class="text-xs" :class="cache.forwarders_tun.state == 'active' ? 'text-green-600' : 'text-gray-900'"  x-text="cache.forwarders_tun.state"></p>
                  </template>
                </div>
                <template x-if="cache.forwarders_tun">
                  <div class="py-4">
                    <div x-show="cache.forwarders_tun.binary.ok">
                      <button @click="apiPostJson('/api/forwarders/tun/start')" :disabled="cache.forwarders_tun.state == 'active'" class="disabled:text-gray-200 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">start</button>
                      <button @click="apiPostJson('/api/forwarders/tun/stop')" :disabled="cache.forwarders_tun.state != 'active'" class="disabled:text-gray-200 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">stop</button>
                    </div>
                    <div x-show="!cache.forwarders_tun.binary.ok" class="bg-red-200 p-2 mt-5 rounded text-xs">
                      <ul>
                        <li>binary.state.exists: <span x-text="cache.forwarders_tun.binary.state.exists"></span></li>
                        <li>binary.state.chown_0: <span x-text="cache.forwarders_tun.binary.state.chown_0"></span></li>
                        <li>binary.state.chmod_x: <span x-text="cache.forwarders_tun.binary.state.chmod_x"></span></li>
                        <li>binary.state.chmod_us: <span x-text="cache.forwarders_tun.binary.state.chmod_us"></span></li>
                      </ul>
                    </div>
                  </div>
                </template>
              </div>

              <div class="border border-gray-200 rounded p-2">
                <div class="flex items-center justify-between">
                  <p class="text-xs text-gray-900 font-medium">Accesskeys</p>
                </div>

                <template x-if="cache.accesskeys">
                  <ul role="list" class="mt-3 divide-y divide-gray-100">
                    <template x-for="accesskey in filterBy(cache.accesskeys, 'state', 'active')">
                      <li class="group flex items-center justify-between py-2">
                        <div class="flex items-center space-x-3 text-xs">
                          <span class="w-2.5 h-2.5 flex-shrink-0 bg-green-600 rounded-full" aria-hidden="true"></span>
                          <div class="flex-1 items-center">
                            <span class="font-medium text-xs leading-6 pl-1">active</span>
                            <span class="font-normal text-gray-500">valid for the next</span>
                            <span :title="expiresDate(accesskey.expiration)" class="text-gray-500 border-b border-dotted border-gray-700" x-text="expiresTimeLeft(accesskey.expiration)"></span>
                          </div>
                        </div>
                        <span class="text-xs" x-text="timeLeft(accesskey.duration)"></span>
                      </li>
                    </template>
                    <template x-for="accesskey in filterBy(cache.accesskeys, 'state', 'inactive')">
                      <li class="group flex items-center justify-between py-2">
                        <div class="flex items-center space-x-3 text-xs">
                          <span class="w-2.5 h-2.5 flex-shrink-0 bg-yellow-600 rounded-full" aria-hidden="true"></span>
                          <div class="flex-1 items-center">
                            <span class="font-medium text-xs leading-6 pl-1">pending</span>
                            <span class="font-normal text-gray-500">activate by</span>
                            <span :title="expiresTimeLeft(accesskey.expiration)" class="text-gray-500 border-b border-dotted border-gray-700" x-text="expiresDate(accesskey.expiration)"></span>
                          </div>
                        </div>
                        <span class="text-xs" x-text="timeLeft(accesskey.duration)"></span>
                      </li>
                    </template>
                    <template x-for="accesskey in filterBy(cache.accesskeys, 'state', 'expired')">
                      <li class="group flex items-center justify-between py-2">
                        <div class="flex items-center space-x-3 text-xs">
                          <span class="w-2.5 h-2.5 flex-shrink-0 bg-red-600 rounded-full" aria-hidden="true"></span>
                          <div class="flex-1 items-center">
                            <span class="font-medium text-xs leading-6 pl-1">expired</span>
                            <span class="font-normal text-gray-500">activate by</span>
                            <span :title="expiresTimeLeft(accesskey.expiration)" class="text-gray-500 border-b border-dotted border-gray-700" x-text="expiresDate(accesskey.expiration)"></span>
                          </div>
                        </div>
                        <span class="text-xs" x-text="timeLeft(accesskey.duration)"></span>
                      </li>
                    </template>
                  </ul>
                </template>

                <template x-if="cache.config">
                  <div class="flex py-4 space-y-2 items-center justify-between">
                    <form class="w-full flex items-center text-xs space-x-3">
                      <input type="checkbox" id="use_on_demand" @change="apiPostJson('/api/config', {'broker': {'accesskey': {'use_on_demand': $event.target.checked}}})" :checked="cache.config.broker.accesskey.use_on_demand">
                      <label for="use_on_demand">activate on demand (<span x-text="cache.config.broker.accesskey.use_on_demand"></span>)</label>
                    </form>
                    <!-- TODO: disabled - actually check if activation is needed and possible -->
                    <button @click="apiPostJson('/api/accesskeys/activate')" :disabled="cache.config.broker.accesskey.use_on_demand" class="whitespace-nowrap disabled:text-gray-200 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">activate accesskey</button>
                  </div>
                </template>

                <div class="my-2 w-full flex items-center text-xs space-x-2" x-data="{url: 'https://libre.wireleap.com/accesskeys'}">
                  <input type="url" x-model="url" class="border border-gray-200 rounded-md p-1.5 focus:ring-indigo-500 focus:border-indigo-500 block w-full">
                  <button @click="apiPostJson('/api/accesskeys/import', {'url': url})" :disabled="!url" class="disabled:text-gray-200 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">import</button>
                </div>

              </div>

              <div class="border border-gray-200 rounded p-2">
                <div class="flex items-center justify-between">
                  <p class="text-xs text-gray-900 font-medium">Circuit</p>
                </div>

                <template x-if="cache.status">
                  <ul role="list" class="mt-3 divide-y divide-gray-100">
                    <template x-if="cache.status.broker.active_circuit.length > 0">
                      <button @click="apiPostJson('/api/reload')" class="whitespace-nowrap disabled:text-gray-200 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">blank out circuit</button>
                    </template>
                    <template x-if="cache.status.broker.active_circuit.length == 0">
                      <li class="group flex items-center justify-between py-2">
                        <div class="flex items-center space-x-3 text-xs">
                          <span class="w-2.5 h-2.5 flex-shrink-0 bg-red-600 rounded-full" aria-hidden="true"></span>
                          <div class="flex-1 items-center">
                            <span class="font-medium text-xs leading-6 pl-1">inactive</span>
                            <span class="font-normal text-gray-500">no relays</span>
                          </div>
                        </div>
                      </li>
                    </template>
                    <template x-for="relay in cache.status.broker.active_circuit">
                      <li class="group flex items-center justify-between py-2">
                        <div class="flex items-center space-x-3 text-xs">
                          <span class="w-2.5 h-2.5 flex-shrink-0 bg-green-600 rounded-full" aria-hidden="true"></span>
                          <div class="flex-1 items-center">
                            <span class="font-medium text-xs leading-6 pl-1">active</span>
                            <span class="font-normal text-gray-500" x-text="relay"></span>
                          </div>
                        </div>
                      </li>
                    </template>
                  </ul>
                </template>

                <template x-if="cache.config">
                  <div class="text-xs flex items-center justify-between py-2">
                    <p>hops: <span x-text="cache.config.broker.circuit.hops"></span></p>
                    <div class="space-x-3">
                      <template x-for="hops in [1, 2, 3]">
                        <button @click="apiPostJson('/api/config', {'broker': {'circuit': {'hops': hops}}})" :class="cache.config.broker.circuit.hops == hops ? 'bg-blue-200' : ''" x-text="hops" class="w-14 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-blue-300"></button>
                      </template>
                    </div>
                  </div>
                </template>


                <template x-if="cache.config">
                  <template x-if="cache.relays">
                    <div class="text-xs">
                      <div x-data="{whitelist: cache.config.broker.circuit.whitelist, whitelist_enabled: cache.config.broker.circuit.whitelist.length > 0}">
                        <ul role="list" class="mt-1 divide-y divide-gray-100 text-xs">
                          <div class="flex py-2 space-y-2 items-center justify-between">
                            <form class="w-full flex items-center text-xs space-x-3">
                              <input type="checkbox" id="whitelist_enabled" @change="if ($event.target.checked) { whitelist=cache.config.broker.circuit.whitelist} else { whitelist=[] }" x-model="whitelist_enabled">
                              <label for="whitelist_enabled">enable whitelist (<span x-text="whitelist_enabled"></span>)</label>
                            </form>
                            <button @click="apiPostJson('/api/config', {'broker': {'circuit': {'whitelist': whitelist}}}); whitelist_enabled = whitelist.length > 0" class="whitespace-nowrap disabled:text-gray-200 border border-gray-300 rounded shadow-sm text-xs px-2 pt-1.5 pb-1 items-center justify-center hover:bg-gray-50">apply</button>
                          </div>

                          <template x-for="relay in filterBy(cache.relays, 'role', 'fronting')">
                            <li class="group flex items-center justify-between py-2">
                              <div class="flex-1 items-center">
                                <input :disabled="!whitelist_enabled" type="checkbox" :value="relay.address" x-model="whitelist">
                                <span class="font-medium text-xs leading-6 pl-1 pr-2" x-text="relay.role"></span>
                                <span class="font-normal text-gray-500" x-text="relay.address"></span>
                              </div>
                              <span x-text="relay.versions.software"></span>
                            </li>
                          </template>

                          <template x-for="relay in filterBy(cache.relays, 'role', 'entropic')">
                            <li class="group flex items-center justify-between py-2">
                              <div class="flex-1 items-center">
                                <input :disabled="!whitelist_enabled" type="checkbox" :value="relay.address" x-model="whitelist">
                                <span class="font-medium text-xs leading-6 pl-1 pr-2" x-text="relay.role"></span>
                                <span class="font-normal text-gray-500" x-text="relay.address"></span>
                              </div>
                              <span x-text="relay.versions.software"></span>
                            </li>
                          </template>

                          <template x-for="relay in filterBy(cache.relays, 'role', 'backing')">
                            <li class="group flex items-center justify-between py-2">
                              <div class="flex-1 items-center">
                                <input :disabled="!whitelist_enabled" type="checkbox" :value="relay.address" x-model="whitelist">
                                <span class="font-medium text-xs leading-6 pl-1 pr-2" x-text="relay.role"></span>
                                <span class="font-normal text-gray-500" x-text="relay.address"></span>
                              </div>
                              <span x-text="relay.versions.software"></span>
                            </li>
                          </template>
                        </ul>
                        <p class="py-1">circuit.whitelist: <span x-text="cache.config.broker.circuit.whitelist"></span></p>
                        <p class="py-1">whitelist: <span x-text="whitelist"></span></p>
                      </div>
                    </div>
                  </template>
                </template>

              </div>

            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- right column -->
    <div class="w-1/3 flex-shrink-0 border-l border-gray-200 bg-gray-50 ">
      <div class="h-full p-6 lg:w-full">
        <div class="relative space-y-5" style="min-height: 16rem">
          <div>
            <p class="text-sm font-bold py-2">Controller</p>
            <template x-if="error.log">
              <p class="p-1 bg-red-200 text-xs rounded" x-text="error.log">
            </template>
            <template x-if="cache.log">
              <pre class="w-full max-h-52 overflow-y-auto text-xs scroll-container" x-text="cache.log" x-init="$watch('cache.log', value => $el.scrollTop = $el.scrollHeight)"></pre>
            </template>
          </div>

          <div>
            <p class="text-sm font-bold py-2">SOCKS Forwarder</p>
            <template x-if="error.forwarders_socks_log">
              <p class="p-1 bg-red-200 text-xs rounded" x-text="error.forwarders_socks_log">
            </template>
            <template x-if="cache.forwarders_socks_log">
              <pre class="w-full max-h-52 overflow-y-auto text-xs scroll-container" x-text="cache.forwarders_socks_log" x-init="$watch('cache.forwarders_socks_log', value => $el.scrollTop = $el.scrollHeight)"></pre>
            </template>
          </div>

          <div>
            <p class="text-sm font-bold py-2">TUN Forwarder</p>
            <template x-if="error.forwarders_tun_log">
              <p class="p-1 bg-red-200 text-xs rounded" x-text="error.forwarders_tun_log">
            </template>
            <template x-if="cache.forwarders_tun_log">
              <pre class="w-full max-h-52 overflow-y-auto text-xs scroll-container" x-text="cache.forwarders_tun_log" x-init="$watch('cache.forwarders_tun_log', value => $el.scrollTop = $el.scrollHeight)"></pre>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

</div>
</body>

<script type="text/javascript">
function alpineInstance() {
  return {
    breakpoints: true,
    cache: {},
    error: {},
    alertSuccess: '',
    alertError: '',
    alertInfo: '',
    initialize() {
      this.refresh();
    },
    refresh() {
      this.apiGetJson("/api/version");
      this.apiGetJson("/api/status");
      this.apiGetText("/api/log");
      this.apiGetJson("/api/config");
      this.apiGetJson("/api/runtime");
      this.apiGetJson("/api/accesskeys");
      this.apiGetJson("/api/relays");
      this.apiGetJson("/api/contract");
      this.apiGetJson("/api/forwarders/socks");
      this.apiGetText("/api/forwarders/socks/log");
      this.apiGetJson("/api/forwarders/tun");
      //this.apiGetText("/api/forwarders/tun/log");
    },
    apiPostJson(uri, data={}) {
      this.alertInfo = 'calling ' + uri;
      let options = { method: 'POST', headers: {'Content-Type': 'applications/json'}, body: JSON.stringify(data) };
      fetch(uri, options)
        .then(response => {
          if (response.ok) return response.json();
          throw response;
        })
        .then(data => {
          console.log(uri);
          console.log(data);

          if (uri.startsWith("/api/forwarders/socks")) {
            this.cache.forwarders_socks = data;
            this.apiGetText("/api/forwarders/socks/log");
          }

          if (uri.startsWith("/api/forwarders/tun")) {
            this.cache.forwarders_tun = data;
            this.apiGetText("/api/forwarders/tun/log");
          }

          if (uri.startsWith("/api/config")) {
            this.cache.config = data;
            this.apiGetText("/api/log");
          }

          if (uri.startsWith("/api/reload")) {
            this.cache.status = data;
            this.apiGetText("/api/log");
          }

          if (uri.startsWith("/api/accesskeys/import")) {
            //TODO: returns raw json file contents, not list of accesskey objects
            //this.cache.accesskeys = data; // append to existing
            console.log('accesskeys/import');
            console.log(data);
            this.alertSuccess = "successfully imported accesskeys";
            this.apiGetJson("/api/accesskeys");
            this.apiGetText("/api/log");
          }

          if (uri.startsWith("/api/accesskeys/activate")) {
            this.alertSuccess = "successfully activated accesskey";
            this.apiGetJson("/api/accesskeys");
            this.apiGetText("/api/log");
          }
        })
        .catch(error => {
          console.log(error);
          error.text().then(data => this.alertError = data);
        })
        .finally(() => {
          this.alertInfo = '';
          //console.log('finally');
        });

    },
    apiGetJson(uri) {
      let cacheKey = uri.replaceAll("/","_").replace('_api_','');
      fetch(uri)
        .then(response => {
          if (response.ok) return response.json();
          throw response;
        })
        .then(data => {
          this.cache[cacheKey] = data;
          this.error[cacheKey] = null;
          //console.log(data);
        })
        .catch(error => {
          this.cache[cacheKey] = null;
          error.text().then(data => this.error[cacheKey] = data );
        })
        .finally(() => {
          //console.log('finally');
        });
    },
    apiGetText(uri) {
      let cacheKey = uri.replaceAll("/","_").replace('_api_','');
      fetch(uri)
        .then(response => {
          if (response.ok) return response.text();
          throw response;
        })
        .then(data => {
          this.cache[cacheKey] = data;
          this.error[cacheKey] = null;
        })
        .catch(error => {
          this.cache[cacheKey] = null;
          error.text().then(data => this.error[cacheKey] = data );
        })
        .finally(() => {
          //console.log('finally');
        });
    },

    filterBy(collection, key, value) {
      return collection.filter(
        entry => entry[key] == value
      );
    },

    //filterByIncludes(collection, key, value) {
    //  return collection.filter(
    //    entry => entry[key].toLowerCase().includes(value.toLowerCase())
    //  );
    //},

    timeLeft(seconds) {
      if (seconds < 1) return "0 seconds";
      var d = Math.floor(seconds / (3600*24));
      var h = Math.floor(seconds % (3600*24) / 3600);
      var m = Math.floor(seconds % 3600 / 60);
      var s = Math.floor(seconds % 60);

      var dDisplay = d > 0 ? d + (d == 1 ? " day" : " days") : "";
      var hDisplay = h > 0 ? h + (h == 1 ? " hour" : " hours") : "";
      var mDisplay = m > 0 ? m + (m == 1 ? " minute" : " minutes") : "";
      var sDisplay = s > 0 ? s + (s == 1 ? " second" : " seconds") : "";

      if (d > 0) return (dDisplay + ", " + hDisplay).replace(/,\s*$/, '');
      if (h > 0) return (hDisplay + ", " + mDisplay).replace(/,\s*$/, '');
      if (m > 0) return (mDisplay + ", " + sDisplay).replace(/,\s*$/, '');
      return sDisplay
    },
    expiresDate(timestamp) {
      let exp = new Date(timestamp * 1000);
      return String(exp).split(" (")[0];
    },
    expiresTimeLeft(timestamp) {
      now = new Date();
      now_unix = Math.floor(now.getTime() / 1000);
      seconds = timestamp - now_unix;
      return this.timeLeft(seconds)
    },

  }
}
</script>

</html>
